# 트랜잭션과 잠금

잠금

- 동시성을 제어하기 위한 기능
- 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 한 시점에 하나의 커넥션만 변경할 수 있게 해준다.

트랜잭션

- 데이터의 정합성을 보장하기 위한 기능

> 격리 수준이란 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것인지 결정하는 레벨

## 트랜잭션

하나의 논리적인 작업 셋에 하나의 쿼리가 있든 두 개 이상의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나 (COMMIT) 혹은 아무것도 적용되지 않아야 (ROLLBACK) 함을 보장해 주는 것

```SQL
CREATE TABLE tab_myisam (
  fdpk INT NOT NULL PRIMARY KEY
) ENGINE=MyISAM;
INSERT INTO tab_myisam (fdpk) VALUES (3);

CREATE TABLE tab_innodb (
  fdpk INT NOT NULL PRIMARY KEY
) ENGINE=INNODB;
INSERT INTO tab_innodb (fdpk) VALUES (3);
```

테스트 데이터를 1건씩 저장 후 `AUTO-COMMIT` 모드에서 쿼리 문장을 확인

```SQL
SET AUTOCOMMI=ON;

INSERT INTO tab_myisam (fdpk) VALUES (1), (2), (3);
INSERT INTO tab_innodb (fdpk) VALUES (1), (2), (3);
```

두 insert 문장 모두 pk 중복 오류로 쿼리가 실패하였지만 조회 결과에는 MyISAM 테이블의 경우 `1`, `2` 데이터는 테이블에 삽입된 상태로 남아있다.
<br />
반면에 InnoDB 의 경우 쿼리 중 일부라도 오류가 나면 전체를 원 상태로 만들어 `INSERT` 문자을 실행하기 전의 상태로 되돌린다.

### 주의 사항

트랜잭션은 DBMS의 커넥션과 동일하게 꼭 필요한 최소한의 코드에만 적용하는 것이 좋다.

- 트랜잭션의 범위를 최소화
- 프로그램의 코드가 데이터베이스 커넥션을 가지고 있는 범위와 트랜잭션이 활성화돼 있는 츠로그램의 범위를 최소화
- 네트워크 작업이 있는 경우 반드시 트랜잭션에서 배제해야 한다

## 잠금

MySQL에서 사용되는 잠금은 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다.

- MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향
- 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지 않는다.

**MySQL 엔진의 잠금 기능**

- 테이블 락
  - 테이블 데이터 동기화
- 메타데이터 락
  - 테이블 구조를 잠금는 락
- 네임드 락
  - 사용자의 필요에 맞게 사용할 수 있는 락

### 글로벌 락

`FLUSH TABLES WITH READ LOCK` 명령으로 획득 가능, 가장 범위가 큼

- 영향이 미치는 범위는 MySQL 서버 전체
- 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향
- 한 세션에서 LOCK 을 잡으면 DDL 문장이나 DML 문장을 실행하는 경우 락이 해제될 떄까지 대기

### backup lock

> MySQL 8.0 부터 InnoDB가 기본 스토리지 엔진이 되면서 더 가벼운 글로벌 락의 필요성이 생겼다. 8.0 부터는 Xtrabackup, Enterprise Backup 과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입되었다.

```SQL
LOCK INSTANCE FOR BACKUP;
-- // execute backup
UNLOCK INSTANCE;
```

특정 세션에서 백업 락을 획득하면 테이블의 스키마나 사용자의 인증관련 정보를 변경할 수 없게 된다.

- 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
- REPAIR TABLE 과 OPTIMIZE TABLE 명령
- 사용자 관리 및 비밀번호 변경

## 테이블 락

테이블 단위로 설정되는 잠금, 명시적 혹은 묵식적으로 특정 테이블의 락을 획득할 수 있다.

- 명시적: `LOCK TABLES table_name [ READ | WRITE ]`
  - `UNLOCK TABLE` 명령으로 잠금 해제
  - 특별한 상황이 아니면 애플리케이션에선 거의 사용 x
- 묵시적: MyISAM 이나 MEMORY 테이블에 데이터를 변경하는 쿼리를 실행하면 발생
  - MySQL 서버가 데이터가 변경되는 테이블에 잠금을 설정하고 데이터를 변경 후 즉시 잠금 해제
  - 쿼리가 실행되는 동안 자동으로 획득, 쿼리 완료 후 자동으로 해제
  - InnoDB 테이블의 경우 단순 데이터 변경 쿼리로 인한 묵시적 테이블 락이 설정되지 않는다.
    - DML 쿼리에서는 무시되고 DDL 쿼리의 경우만 영향을 미친다.

## 네임드 락

`GET_LOCK()` 함수를 이용해 임의의 문자열에 대해 잠금을 설정

- 대상 테이블이나 레코드, `AUTO_INCREMENT` 같은 데이터베이스 객체가 아니다.
- 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금
- 데이터베이스 서버 1대에 5대의 웹서버가 접근하여 정보를 동기화해야 하는 요건같은 **상호 동기화**를 처리해야 할 때 네임드 락을 사용

```SQL
SELECT GET_LOCK('mylock', 2);
SELECT IS_FREE_LOCK ('mylock');
SELECT RELEASE_LOCK ('mylock');

SELECT RELEASE_ALL_LOCKS(); -- // named lock 모두 해제
```
